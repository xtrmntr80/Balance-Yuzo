<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>収支ログ</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, sans-serif; margin: 0; background-color: #111111; color: #ffffff; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 18px; margin: 0 0 14px; }
    .card { border: 1px solid rgba(127,127,127,.35); border-radius: 16px; padding: 14px; margin: 12px 0; background: #1a1a1a; }
    label { display: block; font-size: 12px; opacity: .8; margin: 10px 0 6px; }
    input, button { width: 100%; box-sizing: border-box; padding: 12px; border-radius: 12px; border: 1px solid rgba(127,127,127,.35); background: transparent; font-size: 16px; color: inherit; }
    .row, .btnrow, .totals { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btnrow { margin-top: 12px; }
    .kpi { padding: 12px; border-radius: 14px; border: 1px solid rgba(127,127,127,.35); }
    .kpi .t { font-size: 12px; opacity: .8; margin-bottom: 8px; }
    .kpi .v { font-size: 22px; font-weight: 700; }
    .muted { font-size: 12px; opacity: .75; line-height: 1.5; }
    .hr { height: 1px; background: rgba(127,127,127,.25); margin: 12px 0; }
    .danger { border-color: rgba(255,0,0,.5); color: #ff6666; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>収支ログ</h1>
    <div class="card">
      <div class="totals">
        <div class="kpi"><div class="t">今月の収支</div><div id="kpiMonth" class="v">—</div></div>
        <div class="kpi"><div class="t">累計収支</div><div id="kpiAll" class="v">—</div></div>
      </div>
      <div class="hr"></div>
      <div class="muted">データはブラウザに保存されます。定期的なCSV出力を推奨します。</div>
    </div>

    <div class="card">
      <div class="row">
        <div><label>日付</label><input id="date" type="date" /></div>
        <div><label>メモ</label><input id="memo" type="text" placeholder="例: 〇〇店" /></div>
      </div>
      <div class="row">
        <div><label>投資（円）</label><input id="invest" type="number" inputmode="numeric" /></div>
        <div><label>回収（円）</label><input id="ret" type="number" inputmode="numeric" /></div>
      </div>
      <div class="btnrow">
        <button id="saveBtn" style="background: #333;">保存</button>
        <button id="csvBtn">CSV出力</button>
      </div>
      <div class="btnrow">
        <button id="clearBtn" class="danger">全削除</button>
        <button id="sampleBtn">サンプル</button>
      </div>
      <div id="status" style="margin-top:10px; font-size:12px;"></div>
    </div>
  </div>

<script>
(() => {
  const KEY = "pachi_log_v1";
  const el = (id) => document.getElementById(id);

  // 日本時間に合わせたYYYY-MM-DDを取得
  const getTodayJST = () => {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); // ブラウザの時差を考慮
    return d.toISOString().slice(0, 10);
  };

  const todayISO = getTodayJST();
  el("date").value = todayISO;
  
  // ...以下のコードはそのまま...

  const yen = (n) => (n > 0 ? "+" : "") + new Intl.NumberFormat("ja-JP").format(n) + "円";
  const load = () => JSON.parse(localStorage.getItem(KEY) || "[]");
  const saveAll = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));

  const render = () => {
    const arr = load();
    const nowMonth = todayISO.slice(0,7);
    let all = 0, month = 0;
    arr.forEach(x => {
      const net = (Number(x.ret) || 0) - (Number(x.invest) || 0);
      all += net;
      if (x.date.startsWith(nowMonth)) month += net;
    });
    el("kpiAll").textContent = yen(all);
    el("kpiMonth").textContent = yen(month);
  };

  el("saveBtn").addEventListener("click", () => {
    const data = {
      id: Date.now().toString(36),
      date: el("date").value || todayISO,
      invest: Math.trunc(Number(el("invest").value) || 0),
      ret: Math.trunc(Number(el("ret").value) || 0),
      memo: el("memo").value.trim()
    };
    if (data.invest === 0 && data.ret === 0 && !data.memo) return;
    const arr = load();
    arr.push(data);
    saveAll(arr);
    render();
    ["invest", "ret", "memo"].forEach(id => el(id).value = "");
    el("status").textContent = "保存完了";
    setTimeout(() => el("status").textContent = "", 2000);
  });

  el("csvBtn").addEventListener("click", () => {
    const arr = load();
    if (!arr.length) return;
    const csv = ["id,date,invest,ret,memo"].concat(arr.map(x => `${x.id},${x.date},${x.invest},${x.ret},"${x.memo}"`)).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `log_${todayISO}.csv`;
    a.click();
  });

  el("clearBtn").addEventListener("click", () => {
    if (confirm("全データを削除しますか？")) { localStorage.removeItem(KEY); render(); }
  });

  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
  render();
})();
</script>
</body>
</html>
